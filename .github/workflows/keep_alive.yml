name: Keep Render Services Alive

on:
  schedule:
    # Se ejecuta cada 12 minutos entre las 6 AM y 10:59 PM (hora de Colombia UTC-5)
    # Colombia UTC-5 convertido a UTC:
    # 6 AM Colombia = 11 AM UTC
    # 10 PM Colombia = 3 AM UTC (del d√≠a siguiente)
    - cron: '*/12 11-23 * * *'  # De 6 AM a 6:59 PM (Colombia)
    - cron: '*/12 0-3 * * *'    # De 7 PM a 10:59 PM (Colombia)
  workflow_dispatch: # Permite ejecutar manualmente desde GitHub

jobs:
  ping-services:
    runs-on: ubuntu-latest
    
    steps:
      - name: Verificar horario permitido
        id: check-time
        run: |
          # Obtener hora actual en Colombia (UTC-5)
          CURRENT_HOUR=$(TZ=America/Bogota date +%H)
          CURRENT_TIME=$(TZ=America/Bogota date +"%Y-%m-%d %H:%M:%S")
          echo "Hora actual en Colombia: $CURRENT_TIME"
          
          # Verificar si estamos en horario permitido (6 AM - 10 PM)
          # Permitimos ejecuci√≥n de 06:00 a 22:59
          if [ $CURRENT_HOUR -ge 6 ] && [ $CURRENT_HOUR -le 22 ]; then
            echo "allowed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Horario permitido (6 AM - 10 PM). Procediendo con ping..."
          else
            # Esto podr√≠a pasar si el cron corre justo a las 23:xx o fuera de rango
            echo "allowed=false" >> $GITHUB_OUTPUT
            echo "‚è∏Ô∏è Fuera del horario permitido. Servicios pueden dormir."
          fi
      - name: Ping Application
        if: steps.check-time.outputs.allowed == 'true'
        run: |
          echo "üîÑ Haciendo ping a la aplicaci√≥n..."
          # Usamos -L para seguir redirecciones
          response=$(curl -L -s -o /dev/null -w "%{http_code}" https://inventario-6hyb.onrender.com/)
          echo "Respuesta: $response"
          
          if [ $response -eq 200 ]; then
            echo "‚úÖ Aplicaci√≥n respondi√≥ correctamente"
          else
            echo "‚ö†Ô∏è Aplicaci√≥n respondi√≥ con c√≥digo: $response"
            exit 1
          fi
      - name: Resumen
        if: steps.check-time.outputs.allowed == 'true'
        run: |
          echo "‚úÖ Keep-alive completado exitosamente"
          echo "Pr√≥ximo ping en ~12 minutos"
