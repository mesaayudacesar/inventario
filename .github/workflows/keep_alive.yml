name: Keep Render Services Alive

on:
  schedule:
    # Se ejecuta cada 14 minutos entre las 6 AM y 11:59 PM (hora de Colombia UTC-5)
    # Colombia UTC-5 convertido a UTC:
    # 6 AM Colombia = 11 AM UTC
    # 12 AM Colombia (medianoche) = 5 AM UTC del d√≠a siguiente
    - cron: '*/14 11-23 * * *'  # De 6 AM a 6:59 PM (Colombia)
    - cron: '*/14 0-4 * * *'     # De 7 PM a 11:59 PM (Colombia)
  workflow_dispatch: # Permite ejecutar manualmente desde GitHub

jobs:
  ping-services:
    runs-on: ubuntu-latest
    
    steps:
      - name: Verificar horario permitido
        id: check-time
        run: |
          # Obtener hora actual en Colombia (UTC-5)
          CURRENT_HOUR=$(TZ=America/Bogota date +%H)
          CURRENT_TIME=$(TZ=America/Bogota date +"%Y-%m-%d %H:%M:%S")
          echo "Hora actual en Colombia: $CURRENT_TIME"
          
          # Verificar si estamos en horario permitido (6 AM - 12 AM)
          # Nota: En bash [ 0 -ge 6 ] es falso, pero queremos permitir 0, 1, 2, etc. hasta las 12 PM no, hasta las 12 AM (00:00)
          # El user dijo 6 AM a 11:59 PM.
          # 00:00 es medianoche. ¬øDebe correr a la medianoche? El cron 0-4 incluye 00:00 UTC que es 7PM.
          # El script verifica la hora local de colombia.
          # Si son las 23:00 (11 PM) -> OK.
          # Si son las 00:00 (12 AM) -> El user puso "6 AM y 11:59 PM".
          # Entonces 00:00 ya no deber√≠a correr si es estricto.
          # Pero el cron 0-4 UTC va hasta las 4 AM UTC que son las 11 PM Colombia.
          # Espera. 4 AM UTC = 11 PM de ayer en Colombia?
          # Si Colombia es UTC-5.
          # 04:00 UTC - 5 horas = 23:00 (11 PM) del d√≠a anterior. Correcto.
          # Entonces 05:00 UTC es 00:00 (Medianoche).
          # El cron termina en 4 UTC, o sea a las 11:xx PM.
          # Asi que el script de bash solo necesita validar que sea >= 6.
          # Pero espera, si el cron corre a las 0-4 UTC, en Colombia son las 7PM - 11PM.
          # En ese rango (19 a 23), la hora es >= 6.
          # As√≠ que la condici√≥n `if [ $CURRENT_HOUR -ge 6 ]` cubre todo el rango de 6 AM hasta medianoche.
          # No necesitamos `|| [ $CURRENT_HOUR -lt 0 ]` porque hour siempre es 0-23.
          # Solo hay que asegurar que no corra de 0 a 5 AM.
          # Pero el cron ya limita eso (no hay cron entre 5 UTC y 10 UTC).
          # 5 UTC = 00:00 Colombia.
          # 10 UTC = 05:00 Colombia.
          # As√≠ que el cron ya hace el filtro principal. El check en bash es redundante pero √∫til como doble check o logging.
          
          if [ $CURRENT_HOUR -ge 6 ]; then
            echo "allowed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Horario permitido (>= 6 AM). Procediendo con ping..."
          else
            # Esto pasar√≠a si se ejecuta manualmente entre 12 AM y 5 AM
            echo "allowed=false" >> $GITHUB_OUTPUT
            echo "‚è∏Ô∏è Fuera del horario permitido (12 AM - 6 AM). Servicios pueden dormir."
          fi
      - name: Ping Application
        if: steps.check-time.outputs.allowed == 'true'
        run: |
          echo "üîÑ Haciendo ping a la aplicaci√≥n..."
          # Usamos -L para seguir redirecciones si las hay (ej http->https)
          response=$(curl -L -s -o /dev/null -w "%{http_code}" https://inventario-6hyb.onrender.com/)
          echo "Respuesta: $response"
          
          if [ $response -eq 200 ]; then
            echo "‚úÖ Aplicaci√≥n respondi√≥ correctamente"
          else
            echo "‚ö†Ô∏è Aplicaci√≥n respondi√≥ con c√≥digo: $response"
            exit 1
          fi
      - name: Resumen
        if: steps.check-time.outputs.allowed == 'true'
        run: |
          echo "‚úÖ Keep-alive completado exitosamente"
          echo "Pr√≥ximo ping en ~14 minutos"
